name: JIT
on:
  pull_request:
    paths:
      - '**jit**'
      - 'Python/bytecodes.c'
      - 'Python/optimizer*.c'
      - '!Python/perf_jit_trampoline.c'
      - '!**/*.md'
      - '!**/*.ini'
  push:
    paths:
      - '**jit**'
      - 'Python/bytecodes.c'
      - 'Python/optimizer*.c'
      - '!Python/perf_jit_trampoline.c'
      - '!**/*.md'
      - '!**/*.ini'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  interpreter:
    name: Interpreter (Debug)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Build tier two interpreter
        run: |
          ./configure --enable-experimental-jit=interpreter --with-pydebug
          make all --jobs 4

  jit:
    name: ${{ matrix.target }} (${{ matrix.debug && 'Debug' || 'Release' }})
    needs: interpreter
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-apple-darwin/clang
          - aarch64-apple-darwin/clang
        debug:
          - true
          - false
        llvm:
          - 19
        include:
          - target: x86_64-apple-darwin/clang
            architecture: x86_64
            runner: macos-13
            compiler: clang
          - target: aarch64-apple-darwin/clang
            architecture: aarch64
            runner: macos-14
            compiler: clang
    env:
      CC: ${{ matrix.compiler }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Ensure Python 3.13 is installed
        run: |
          brew update
          if ! brew ls --versions python@3.13 > /dev/null; then
            brew install python@3.13
          fi
          find /usr/local/bin -lname '*/Library/Frameworks/Python.framework/*' -delete
          brew unlink python@3.11 || true
          brew link --force --overwrite python@3.13
          brew install llvm@${{ matrix.llvm }}
          SDKROOT="$(xcrun --show-sdk-path)" \
            ./configure --enable-experimental-jit ${{ matrix.debug && '--with-pydebug' || '--enable-optimizations --with-lto' }}
          make all --jobs 4
          ./python.exe -m test --multiprocess 0 --timeout 4500 --verbose2 --verbose3